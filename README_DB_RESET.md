# Інструкція по перестворенню бази даних

## Проблема
Існуюча база даних має стару схему без нових колонок та таблиць для реферальної системи.

## Рішення

### Варіант 1: Автоматичне оновлення (рекомендовано)
Функція `create_tables()` в `db/queries.py` тепер автоматично:
- Створює всі потрібні таблиці якщо їх немає
- Додає відсутні колонки до існуючих таблиць
- Створює всі необхідні індекси

**Для застосування:**
```bash
# Перезапустіть бот - схема оновиться автоматично
docker-compose restart crypto_bot
```

### Варіант 2: Повне перестворення БД
Якщо потрібно повністю очистити базу та створити заново:

```bash
# 1. Зупиніть контейнери
docker-compose down

# 2. Видаліть volume з даними (УВАГА: всі дані будуть втрачені!)
docker volume rm cryptofuture_postgres_data

# 3. Запустіть знову
docker-compose up -d
```

### Варіант 3: Ручне перестворення через SQL
Якщо потрібно перестворити схему вручну:

```bash
# Підключіться до контейнера PostgreSQL
docker exec -it crypto_postgres psql -U admin -d casino

# Виконайте команди з файлу reset_db.sql
\i /docker-entrypoint-initdb.d/reset_db.sql
```

## Перевірка
Після будь-якого варіанту перевірте лог бота:
```bash
docker-compose logs crypto_bot
```

Повинно бути повідомлення: "Всі таблиці та індекси успішно створені/оновлені"

## Структура нової БД

### Таблиця `users`
- `user_id` - ID користувача
- `username` - username Telegram
- `first_name` - ім'я користувача  
- `free_trades_left` - кількість безкоштовних спроб
- `is_subscribed` - статус підписки
- `subscription_expires_at` - дата закінчення підписки
- `referral_code` - **НОВА** реферальний код через який прийшов
- `created_at` - **НОВА** дата реєстрації

### Таблиця `referral_links` (НОВА)
- `id` - автоінкремент ID
- `code` - унікальний код посилання
- `name` - назва/опис посилання
- `admin_id` - хто створив посилання
- `created_at` - дата створення
- `is_active` - активність посилання

### Таблиця `referral_stats` (НОВА)  
- `id` - автоінкремент ID
- `referral_code` - код посилання
- `user_id` - користувач який виконав дію
- `action_type` - тип дії ('click', 'register', 'subscription')
- `created_at` - дата дії
