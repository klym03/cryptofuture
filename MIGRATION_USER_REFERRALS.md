# –ú—ñ–≥—Ä–∞—Ü—ñ—è: –î–æ–¥–∞–≤–∞–Ω–Ω—è –∫–æ—Ä–∏—Å—Ç—É–≤–∞—Ü—å–∫–æ—ó —Ä–µ—Ñ–µ—Ä–∞–ª—å–Ω–æ—ó —Å–∏—Å—Ç–µ–º–∏

## –©–æ –Ω–æ–≤–æ–≥–æ?

–¢–µ–ø–µ—Ä –∫–æ–∂–µ–Ω –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á –º–∞—î –≤–ª–∞—Å–Ω–µ —Ä–µ—Ñ–µ—Ä–∞–ª—å–Ω–µ –ø–æ—Å–∏–ª–∞–Ω–Ω—è —Ç–∞ –º–æ–∂–µ –∑–∞–ø—Ä–æ—à—É–≤–∞—Ç–∏ –¥—Ä—É–∑—ñ–≤ —ñ –ø–µ—Ä–µ–≥–ª—è–¥–∞—Ç–∏ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É —Å–≤–æ—ó—Ö —Ä–µ—Ñ–µ—Ä–∞–ª—ñ–≤.

## –ó–º—ñ–Ω–∏ –≤ –±–∞–∑—ñ –¥–∞–Ω–∏—Ö

### –ù–æ–≤—ñ –∫–æ–ª–æ–Ω–∫–∏ –≤ —Ç–∞–±–ª–∏—Ü—ñ `users`:
- `user_referral_code TEXT UNIQUE` - –≤–ª–∞—Å–Ω–∏–π —Ä–µ—Ñ–µ—Ä–∞–ª—å–Ω–∏–π –∫–æ–¥ –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á–∞

### –ù–æ–≤—ñ —ñ–Ω–¥–µ–∫—Å–∏:
- `idx_users_user_referral_code` - –¥–ª—è —à–≤–∏–¥–∫–æ–≥–æ –ø–æ—à—É–∫—É –∑–∞ —Ä–µ—Ñ–µ—Ä–∞–ª—å–Ω–∏–º –∫–æ–¥–æ–º

## –Ü–Ω—Å—Ç—Ä—É–∫—Ü—ñ—ó –¥–ª—è –æ–Ω–æ–≤–ª–µ–Ω–Ω—è

### –í–∞—Ä—ñ–∞–Ω—Ç 1: –ê–≤—Ç–æ–º–∞—Ç–∏—á–Ω–∞ –º—ñ–≥—Ä–∞—Ü—ñ—è (—Ä–µ–∫–æ–º–µ–Ω–¥–æ–≤–∞–Ω–æ)

–ü—Ä–∏ –Ω–∞—Å—Ç—É–ø–Ω–æ–º—É –∑–∞–ø—É—Å–∫—É –±–æ—Ç–∞ –≤—Å—ñ –∑–º—ñ–Ω–∏ –∑–∞—Å—Ç–æ—Å—É—é—Ç—å—Å—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–Ω–æ. –ü—Ä–æ—Å—Ç–æ –ø–µ—Ä–µ–∑–∞–ø—É—Å—Ç—ñ—Ç—å –±–æ—Ç–∞:

```bash
docker-compose restart bot
```

–ë–æ—Ç –∞–≤—Ç–æ–º–∞—Ç–∏—á–Ω–æ:
- –î–æ–¥–∞—Å—Ç—å –Ω–æ–≤—É –∫–æ–ª–æ–Ω–∫—É `user_referral_code`
- –°—Ç–≤–æ—Ä–∏—Ç—å —ñ–Ω–¥–µ–∫—Å
- –ó–≥–µ–Ω–µ—Ä—É—î —Ä–µ—Ñ–µ—Ä–∞–ª—å–Ω—ñ –∫–æ–¥–∏ –¥–ª—è –Ω–æ–≤–∏—Ö –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á—ñ–≤

### –í–∞—Ä—ñ–∞–Ω—Ç 2: –†—É—á–Ω–∞ –º—ñ–≥—Ä–∞—Ü—ñ—è (—è–∫—â–æ –ø–æ—Ç—Ä—ñ–±–Ω–æ)

–Ø–∫—â–æ —Ö–æ—á–µ—Ç–µ –∑–≥–µ–Ω–µ—Ä—É–≤–∞—Ç–∏ –∫–æ–¥–∏ –¥–ª—è —ñ—Å–Ω—É—é—á–∏—Ö –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á—ñ–≤:

```bash
docker-compose exec postgres psql -U patrick -d casino
```

–ü–æ—Ç—ñ–º –≤–∏–∫–æ–Ω–∞–π—Ç–µ SQL:

```sql
-- –î–æ–¥–∞—Ç–∏ –∫–æ–ª–æ–Ω–∫—É (—è–∫—â–æ –Ω–µ –¥–æ–¥–∞–ª–∞—Å—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–Ω–æ)
ALTER TABLE users ADD COLUMN IF NOT EXISTS user_referral_code TEXT UNIQUE;

-- –°—Ç–≤–æ—Ä–∏—Ç–∏ —ñ–Ω–¥–µ–∫—Å (—è–∫—â–æ –Ω–µ —Å—Ç–≤–æ—Ä–∏–≤—Å—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–Ω–æ)
CREATE INDEX IF NOT EXISTS idx_users_user_referral_code ON users(user_referral_code);

-- –ó–≥–µ–Ω–µ—Ä—É–≤–∞—Ç–∏ —Ä–µ—Ñ–µ—Ä–∞–ª—å–Ω—ñ –∫–æ–¥–∏ –¥–ª—è —ñ—Å–Ω—É—é—á–∏—Ö –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á—ñ–≤ (–æ–ø—Ü—ñ–æ–Ω–∞–ª—å–Ω–æ)
-- –ü—Ä–∏–º—ñ—Ç–∫–∞: –∫–æ–¥–∏ –±—É–¥—É—Ç—å –∑–≥–µ–Ω–µ—Ä–æ–≤–∞–Ω—ñ –∞–≤—Ç–æ–º–∞—Ç–∏—á–Ω–æ –ø—Ä–∏ –ø–µ—Ä—à–æ–º—É –≤–∏–∫–æ—Ä–∏—Å—Ç–∞–Ω–Ω—ñ —Ñ—É–Ω–∫—Ü—ñ—ó
```

## –ù–æ–≤–∞ —Ñ—É–Ω–∫—Ü—ñ–æ–Ω–∞–ª—å–Ω—ñ—Å—Ç—å –¥–ª—è –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á—ñ–≤

### 1. –í–ª–∞—Å–Ω–µ —Ä–µ—Ñ–µ—Ä–∞–ª—å–Ω–µ –ø–æ—Å–∏–ª–∞–Ω–Ω—è
–ö–æ–∂–µ–Ω –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á –æ—Ç—Ä–∏–º—É—î —É–Ω—ñ–∫–∞–ª—å–Ω–µ –ø–æ—Å–∏–ª–∞–Ω–Ω—è —Ñ–æ—Ä–º–∞—Ç—É:
```
https://t.me/–í–ê–®_–ë–û–¢?start=U123456_ABCD
```

### 2. –ü–µ—Ä–µ–≥–ª—è–¥ —Ä–µ—Ñ–µ—Ä–∞–ª—ñ–≤
–ö–æ—Ä–∏—Å—Ç—É–≤–∞—á—ñ –º–æ–∂—É—Ç—å –Ω–∞—Ç–∏—Å–Ω—É—Ç–∏ –∫–Ω–æ–ø–∫—É "üîó –ú–æ—ó —Ä–µ—Ñ–µ—Ä–∞–ª–∏" —Ç–∞ –ø–æ–±–∞—á–∏—Ç–∏:
- –°–≤–æ—î —Ä–µ—Ñ–µ—Ä–∞–ª—å–Ω–µ –ø–æ—Å–∏–ª–∞–Ω–Ω—è
- –ó–∞–≥–∞–ª—å–Ω—É –∫—ñ–ª—å–∫—ñ—Å—Ç—å –∑–∞–ø—Ä–æ—à–µ–Ω–∏—Ö –¥—Ä—É–∑—ñ–≤
- –°–∫—ñ–ª—å–∫–∏ –∑ –Ω–∏—Ö –æ—Ñ–æ—Ä–º–∏–ª–∏ –ø—ñ–¥–ø–∏—Å–∫—É
- –°–ø–∏—Å–æ–∫ –æ—Å—Ç–∞–Ω–Ω—ñ—Ö 10 —Ä–µ—Ñ–µ—Ä–∞–ª—ñ–≤ –∑ –¥–∞—Ç–∞–º–∏ —Ä–µ—î—Å—Ç—Ä–∞—Ü—ñ—ó

### 3. –í—ñ–¥—Å—Ç–µ–∂–µ–Ω–Ω—è —Ä–µ—Ñ–µ—Ä–∞–ª—ñ–≤
–°–∏—Å—Ç–µ–º–∞ –∞–≤—Ç–æ–º–∞—Ç–∏—á–Ω–æ –≤—ñ–¥—Å—Ç–µ–∂—É—î:
- –•—Ç–æ –ø—Ä–∏–π—à–æ–≤ –∑–∞ —Ä–µ—Ñ–µ—Ä–∞–ª—å–Ω–∏–º –ø–æ—Å–∏–ª–∞–Ω–Ω—è–º
- –î–∞—Ç—É —Ä–µ—î—Å—Ç—Ä–∞—Ü—ñ—ó
- –°—Ç–∞—Ç—É—Å –ø—ñ–¥–ø–∏—Å–∫–∏ –∫–æ–∂–Ω–æ–≥–æ —Ä–µ—Ñ–µ—Ä–∞–ª–∞

## –ó–º—ñ–Ω–∏ –≤ –∫–æ–¥—ñ

### –û–Ω–æ–≤–ª–µ–Ω—ñ —Ñ–∞–π–ª–∏:
1. `init.sql` - –¥–æ–¥–∞–Ω–∞ –∫–æ–ª–æ–Ω–∫–∞ `user_referral_code`
2. `db/queries.py` - –¥–æ–¥–∞–Ω—ñ —Ñ—É–Ω–∫—Ü—ñ—ó:
   - `generate_user_referral_code(user_id)` - –≥–µ–Ω–µ—Ä–∞—Ü—ñ—è –∫–æ–¥—É
   - `get_user_referrals(user_id)` - —Å–ø–∏—Å–æ–∫ —Ä–µ—Ñ–µ—Ä–∞–ª—ñ–≤
   - `get_user_referral_stats(user_id)` - —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞
   - `ensure_user_referral_code(user_id)` - –≥–∞—Ä–∞–Ω—Ç—É—î –Ω–∞—è–≤–Ω—ñ—Å—Ç—å –∫–æ–¥—É
   - `get_user_by_referral_code(code)` - –ø–æ—à—É–∫ –∑–∞ –∫–æ–¥–æ–º
3. `bot/handlers/user_handlers.py` - –¥–æ–¥–∞–Ω–æ:
   - `cmd_referrals()` - –æ–±—Ä–æ–±–Ω–∏–∫ –¥–ª—è –ø–µ—Ä–µ–≥–ª—è–¥—É —Ä–µ—Ñ–µ—Ä–∞–ª—ñ–≤
   - –ü–æ–∫—Ä–∞—â–µ–Ω–∞ –ª–æ–≥—ñ–∫–∞ –≤ `cmd_start()` –¥–ª—è –ø—ñ–¥—Ç—Ä–∏–º–∫–∏ –∫–æ—Ä–∏—Å—Ç—É–≤–∞—Ü—å–∫–∏—Ö –ø–æ—Å–∏–ª–∞–Ω—å
4. `bot/keyboards/reply.py` - –¥–æ–¥–∞–Ω–∞ –∫–Ω–æ–ø–∫–∞ "üîó –ú–æ—ó —Ä–µ—Ñ–µ—Ä–∞–ª–∏"

## –°—É–º—ñ—Å–Ω—ñ—Å—Ç—å

- ‚úÖ –°—Ç–∞—Ä—ñ –∞–¥–º—ñ–Ω—Å—å–∫—ñ —Ä–µ—Ñ–µ—Ä–∞–ª—å–Ω—ñ –ø–æ—Å–∏–ª–∞–Ω–Ω—è –ø—Ä–æ–¥–æ–≤–∂—É—é—Ç—å –ø—Ä–∞—Ü—é–≤–∞—Ç–∏
- ‚úÖ –Ü—Å–Ω—É—é—á—ñ –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á—ñ –æ—Ç—Ä–∏–º–∞—é—Ç—å –∫–æ–¥–∏ –∞–≤—Ç–æ–º–∞—Ç–∏—á–Ω–æ –ø—Ä–∏ –ø–µ—Ä—à–æ–º—É –Ω–∞—Ç–∏—Å–∫–∞–Ω–Ω—ñ "–ú–æ—ó —Ä–µ—Ñ–µ—Ä–∞–ª–∏"
- ‚úÖ –ù–æ–≤—ñ –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á—ñ –æ—Ç—Ä–∏–º—É—é—Ç—å –∫–æ–¥ –≤—ñ–¥—Ä–∞–∑—É –ø—Ä–∏ —Ä–µ—î—Å—Ç—Ä–∞—Ü—ñ—ó
- ‚úÖ –ü—ñ–¥—Ç—Ä–∏–º—É—î—Ç—å—Å—è —è–∫ –∞–¥–º—ñ–Ω—Å—å–∫–∞, —Ç–∞–∫ —ñ –∫–æ—Ä–∏—Å—Ç—É–≤–∞—Ü—å–∫–∞ —Ä–µ—Ñ–µ—Ä–∞–ª—å–Ω–∞ —Å–∏—Å—Ç–µ–º–∞ –ø–∞—Ä–∞–ª–µ–ª—å–Ω–æ

## –¢–µ—Å—Ç—É–≤–∞–Ω–Ω—è

–ü—ñ—Å–ª—è –æ–Ω–æ–≤–ª–µ–Ω–Ω—è –ø–µ—Ä–µ–≤—ñ—Ä—Ç–µ:
1. –ù–∞—Ç–∏—Å–Ω—ñ—Ç—å "üîó –ú–æ—ó —Ä–µ—Ñ–µ—Ä–∞–ª–∏" - –º–∞—î –ø–æ–∫–∞–∑–∞—Ç–∏ –≤–∞—à–µ –ø–æ—Å–∏–ª–∞–Ω–Ω—è
2. –°–∫–æ–ø—ñ—é–π—Ç–µ –ø–æ—Å–∏–ª–∞–Ω–Ω—è —Ç–∞ –≤—ñ–¥–∫—Ä–∏–π—Ç–µ –≤ —ñ–Ω—à–æ–º—É –∞–∫–∞—É–Ω—Ç—ñ
3. –ü–µ—Ä–µ–≤—ñ—Ä—Ç–µ —â–æ –Ω–æ–≤–∏–π –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á –∑'—è–≤–∏–≤—Å—è —É –≤–∞—à–æ–º—É —Å–ø–∏—Å–∫—É —Ä–µ—Ñ–µ—Ä–∞–ª—ñ–≤
4. –ü–µ—Ä–µ–≤—ñ—Ä—Ç–µ —â–æ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –∫–æ—Ä–µ–∫—Ç–Ω–æ –æ–Ω–æ–≤–ª—é—î—Ç—å—Å—è

## Rollback (–≤—ñ–¥–∫–∞—Ç)

–Ø–∫—â–æ –ø–æ—Ç—Ä—ñ–±–Ω–æ –≤—ñ–¥–∫–æ—Ç–∏—Ç–∏ –∑–º—ñ–Ω–∏:

```sql
-- –í–∏–¥–∞–ª–∏—Ç–∏ –∫–æ–ª–æ–Ω–∫—É (–≤—Å—ñ –¥–∞–Ω—ñ –±—É–¥—É—Ç—å –≤—Ç—Ä–∞—á–µ–Ω—ñ!)
ALTER TABLE users DROP COLUMN IF EXISTS user_referral_code;

-- –í–∏–¥–∞–ª–∏—Ç–∏ —ñ–Ω–¥–µ–∫—Å
DROP INDEX IF EXISTS idx_users_user_referral_code;
```

–ü–æ—Ç—ñ–º –ø–æ–≤–µ—Ä–Ω—ñ—Ç—å –ø–æ–ø–µ—Ä–µ–¥–Ω—ñ –≤–µ—Ä—Å—ñ—ó —Ñ–∞–π–ª—ñ–≤ –∑ git.

